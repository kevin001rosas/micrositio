<!doctype html>
<html lang="en">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      
      <!-- Bootstrap CSS -->
      
      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">

      <!-- jQuery library -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

      <!-- Popper JS -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

      <!-- Latest compiled JavaScript -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>

      <title>Micrositio</title>
      <link href="https://fonts.googleapis.com/css?family=Work+Sans" rel="stylesheet">

      <!--Cargamos los íconos-->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      

      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">

      <!-- Latest compiled and minified JavaScript -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>

      <script src="./js/cookie.js"></script>
      <script src="./js/utilidades.js"></script>      
      <link rel="stylesheet" href="./css/estilos.css">
      <div id="loading"></div>
   <script>
    
      var url_foto = ""; 
      var ciudades_lista = {}; 
      $(document).ready(function() {
       //llenar_menu(); 
       //llenar_encabezado();        
       llenar_comboboxes(); 
       quitar_loading(); 
       poner_fecha_de_hoy("fecha_de_nacimiento");                
      });

      function regresar()
      {
        window.location.href = base_url;
      }
      
            
      function llenar_comboboxes()
      {        
        llenar_tipos_de_usuario(); 
        llenar_distribuidores();         
        llenar_ciudades();                 
      }

    function llenar_tipos_de_mascota()
      {
        contador_solicitudes++;
        var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/tiposdemascota`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`, 
             "id_tipo_de_usuario": `${Cookies.get('id_tipo_de_usuario')}`
           },
           "processData": false,                      
            success: function(data){
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);                

             
      
             //Limpiamos el contenido actual 
             $("#id_tipo_de_mascota_1").html("");
             $("#id_tipo_de_mascota_2").html("");
             $("#id_tipo_de_mascota_3").html("");

             var nuevo_contenido = ""; 

             //Llenamos las nuevas opciones. 
             for (var x =  0; x < obj.length; x++) 
             {
               var id = obj[x]["id"]; 
               var nombre = obj[x]["nombre"];                
               nuevo_contenido += `<option value="${id}">${nombre}</option>`; 
             }

             $("#id_tipo_de_mascota_1").html(nuevo_contenido);
             $("#id_tipo_de_mascota_2").html(nuevo_contenido);
             $("#id_tipo_de_mascota_3").html(nuevo_contenido);

             //Seleccinamos la primera opción (para llenar las razas)
             $('#id_tipo_de_mascota_1').selectpicker('val', $("#id_tipo_de_mascota_1 option:first").val());
             $("#id_tipo_de_mascota_1").selectpicker('refresh');

             $('#id_tipo_de_mascota_2').selectpicker('val', $("#id_tipo_de_mascota_2 option:first").val());
             $("#id_tipo_de_mascota_2").selectpicker('refresh');

             $('#id_tipo_de_mascota_3').selectpicker('val', $("#id_tipo_de_mascota_3 option:first").val());
             $("#id_tipo_de_mascota_3").selectpicker('refresh'); 
           }
            , error: function() {
               //Volvemos a invocar la función. 
               if(contador_solicitudes<cantidad_maxima_solicitudes)
               llenar_tipos_de_mascotas();
            } 
         }
      
         $.ajax(settings);         
      }

      function llenar_razas(numero)
      {
        //form-control Obtenemos el nuevo id modificado. 
        var id = $('#id_tipo_de_mascota_' + numero).selectpicker('val'); 
        
                //Obtenemos la información del id.
         var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/tiposdemascota/${id}`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           "processData": false,                      
            success: function(data){    
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);                    
                   
             var nuevo_contenido = ""; 
      
             //Cambiamos el valor actual del id para preparar el update  
             for (var x =  0; x < obj.length; x++) 
             {
              if(obj[x]["id_raza"]==null || obj[x]["id_raza"]=="")
                continue; 
               var id_raza = obj[x]["id_raza"]; 
               var raza = obj[x]["raza"]; 
               var talla = obj[x]["talla"] ===""? "": `(${obj[x]["talla"]})`; 
               nuevo_contenido += `<option value="${id_raza}">${raza} ${talla}</option>`;
               
             }            

             $('#id_raza_' + numero).html(nuevo_contenido);   
             //Seleccinamos la primera opción (para llenar las razas)
             $('#id_raza_' + numero).selectpicker('val', $("#id_raza_" + numero +" option:first").val());
             $('#id_raza_' + numero).selectpicker('refresh'); 
           }
         }
      
         $.ajax(settings); 
        
      }          


      

      function seleccionar_distribuidor()
      { 
        for (const index in ciudades_lista) 
        { 
          if($("#id_ciudad").val()==ciudades_lista[index].id)          
          {
            //Seleccionamos el distribuidor correcto. 
            $("#id_distribuidor").val(ciudades_lista[index].id_distribuidor);
            $("#id_distribuidor").selectpicker('refresh');
            return; 
          }

        }

      }


      function llenar_ciudades()
      {
        contador_solicitudes++;
        var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/ciudades`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           "processData": false,                      
            success: function(data){    
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);                
      
             
      
             //Limpiamos el contenido actual 
             $("#id_ciudad").html("");
             var nuevo_contenido = ""; 
      
             //Llenamos las nuevas opciones. 
             for (var x =  0; x < obj.length; x++) 
             {
              ciudades_lista[x] = {}; 

               //Guardamos a las ciudades en una lista automáticamente. 
               ciudades_lista[x].id = obj[x]["id"]; 
               ciudades_lista[x].nombre = obj[x]["nombre"];
               ciudades_lista[x].id_distribuidor = obj[x]["id_distribuidor"]; 

               var id = obj[x]["id"]; 
               var nombre = obj[x]["nombre"];                
               nuevo_contenido += `<option value="${id}">${nombre}</option>`; 
             }
      
             $("#id_ciudad").html(nuevo_contenido);   
             //Seleccinamos la primera opción 
             $('#id_ciudad').selectpicker('val', $("#id_ciudad option:first").val());
             $("#id_ciudad").selectpicker('refresh'); 
           }
           , error: function() {
               //Volvemos a invocar la función. 
               if(contador_solicitudes<cantidad_maxima_solicitudes)
               llenar_ciudades();                
            }
         }
      
         $.ajax(settings);         
      }

      function llenar_distribuidores()
      {
        contador_solicitudes++;
        var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/distribuidores`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           "processData": false,                      
            success: function(data){    
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);                
      
             
      
             //Limpiamos el contenido actual 
             $("#id_distribuidor").html("");
             var nuevo_contenido = ""; 
      
             //Llenamos las nuevas opciones. 
             for (var x =  0; x < obj.length; x++) 
             {
               var id = obj[x]["id"]; 
               var nombre = obj[x]["nombre"];                
               nuevo_contenido += `<option value="${id}">${nombre}</option>`; 
             }
      
             $("#id_distribuidor").html(nuevo_contenido);   
             //Seleccinamos la primera opción 
             $('#id_distribuidor').selectpicker('val', $("#id_distribuidor option:first").val());
             $("#id_distribuidor").selectpicker('refresh'); 
           }
           , error: function() {
               //Volvemos a invocar la función. 
               if(contador_solicitudes<cantidad_maxima_solicitudes)
               llenar_distribuidores();                
            }
         }
      
         $.ajax(settings);         
      }      

      function llenar_marcas()
      {
        contador_solicitudes++;
        var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/marcas`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           "processData": false,                      
            success: function(data){    
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);                
      
             
      
             //Limpiamos el contenido actual 
             $("#id_marca").html("");
             var nuevo_contenido = ""; 
      
             //Llenamos las nuevas opciones. 
             for (var x =  0; x < obj.length; x++) 
             {
               var id = obj[x]["id"]; 
               var nombre = obj[x]["nombre"];                
               nuevo_contenido += `<option value="${id}">${nombre}</option>`; 
             }
      
             $("#id_marca").html(nuevo_contenido);   
             //Seleccinamos la primera opción 
             $('#id_marca').selectpicker('val', $("#id_marca option:first").val());
             $("#id_marca").selectpicker('refresh'); 
           }
           , error: function() {
               //Volvemos a invocar la función. 
               if(contador_solicitudes<cantidad_maxima_solicitudes)
               llenar_marcas();                
            }
         }
      
         $.ajax(settings);         
      }      

      function llenar_tipos_de_usuario()
      {
        contador_solicitudes++; 
        var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/tiposdeusuario`, 
           "method": "GET",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           "processData": false,              
            success: function(data){    
            //console.log(data); 
            //Parseamos la información. 
             var obj = JSON.parse(data);        

             //Limpiamos el contenido actual 
             $("#id_tipo_de_usuario").html("");
             var nuevo_contenido = ""; 
      
             //Llenamos las nuevas opciones. 
             for (var x =  0; x < obj.length; x++) 
             {
               var id = obj[x]["id"]; 
               var nombre = obj[x]["nombre"];                
               nuevo_contenido += `<option value="${id}">${nombre}</option>`; 
             }
      
             $("#id_tipo_de_usuario").html(nuevo_contenido);   
             //Seleccinamos la primera opción
             $('#id_tipo_de_usuario').selectpicker('val', $("#id_tipo_de_usuario option:first").val());
             $("#id_tipo_de_usuario").selectpicker('refresh'); 
           }
            , error: function(data) {
               //Volvemos a invocar la función. 
               if(contador_solicitudes<7)
                llenar_tipos_de_usuario();                
            }
         }
      
         $.ajax(settings);         
      }

      function validacion()
      {      
        $("#errores").hide(); 
        $('html,body').animate({
                       scrollTop: $("#errores").offset().bottom},'slow');

        if($("#secret").val()!=$("#secret_2").val())
        {
          $("#errores").html("Las contraseñas no coinciden."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#nombres").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un nombre."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#apellido_paterno").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un apellido paterno."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#apellido_materno").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un apellido materno."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#telefono_local").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un teléfono local."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#telefono_celular").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un teléfono celular."); 
          $("#errores").show("slow");              
          return false; 
        }
        if($("#email").val().trim()==="") 
        {
          $("#errores").html("Por favor, especifica un email."); 
          $("#errores").show("slow");              
          return false; 
        }

        if(telefono_local_valido($("#telefono_local").val())==false)
        {
          //Hacemos el append de los errores y mostramos los errores.
          $("#errores").html("El teléfono local debe ser de 8 dígitos."); 
          $("#errores").show("slow");    
          return false; 
        }
        if(telefono_celular_valido($("#telefono_celular").val())==false)
        {
          //Hacemos el append de los errores y mostramos los errores.
          $("#errores").html("El teléfono celular debe ser de 10 dígitos."); 
          $("#errores").show("slow");    
          return false; 
        }        

        if(correo_valido($("#email").val())==false)
        {
          //Hacemos el append de los errores y mostramos los errores.
          $("#errores").html("El correo electrónico no es válido."); 
          $("#errores").show("slow");    
          return false; 
        }        

        if(correo_cliente_inexistente($("#email").val())==false) 
        {
          $("#errores").html("El correo especificado ya pertenece a otro cliente."); 
          $("#errores").show("slow");              
          return false; 
        } 

        if(correo_usuario_inexistente($("#email").val())==false) 
        {
          $("#errores").html("El correo especificado pertenece a un usuario."); 
          $("#errores").show("slow");              
          return false; 
        }    
        

        return true; 


      }

      function insertar()
      {
         if(validacion()==false)
          return; 
         //Modificamos la raza con Ajax. 
         var form = {};

          form.nombres = $("#nombres").val();
          form.apellido_paterno = $("#apellido_paterno").val();
          form.apellido_materno = $("#apellido_materno").val();
          form.telefono_local = $("#telefono_local").val();
          form.telefono_celular = $("#telefono_celular").val();
          form.email = $("#email").val();          
          form.secret = $("#secret").val();
          form.id_tipo_de_usuario = $("#id_tipo_de_usuario").val();
          form.fecha_de_nacimiento = $("#fecha_de_nacimiento").val();
          form.id_ciudad = $("#id_ciudad").val();          
          form.id_distribuidor = $("#id_distribuidor").val();          
          //console.log(form); 


         var settings = {
           "async": false,
           "crossDomain": true,
           "url": `${api_url}/usuarios/preregistro`, 
           "method": "POST",
           "headers": {
             "Content-Type": "application/json",
             "cache-control": "no-cache",
             "token": `${Cookies.get('token')}`, 
             "id_usuario": `${Cookies.get('id_usuario')}`
           },
           success: function(data)
           {
            //console.log(data); 
            if(data==="incorrecto")
            {
              mostrar_errores("errores", "Ocurrió un error al solicitar los accesos. Por favor, inténtelo de nuevo o contacte a soporte técnico si el problema persiste.")              
              return; 
            }

            //Mostramos el mensaje de éxito. 
            $("#div_datos_de_solicitud").hide(); 
            $("#div_completado").show("slow");             

           }, 
           error: function(data)
           {
              mostrar_errores("errores", "Ocurrió un error al solicitar los accesos. Por favor, inténtelo de nuevo o contacte a soporte técnico si el problema persiste.")              
              return; 
           }, 
           "processData": false,
           "data": JSON.stringify(form)
         }
      
         $.ajax(settings); 
      }

      
      
   </script>
   <style>
   </style>
   <body>
      <div class="container-fluid" >
      <div class="row">
        <div class='col-12' style='text-align:center;background-color: white;'>
            <img src='./images/royal_canin_logo_02.jpg' style='padding-left:15px;margin-bottom:15px;height: 100px; width:auto;'>
        </div>         
      </div>
      <div class="row">
         <!-- Contenido de la página --> 
         <div id="contenido_de_pagina" class="col-12 contenido_de_pagina_red" style="padding-top: 5vh;padding-bottom: 5vh;">
            <div class="row justify-content-center">
               <div class="col-8 form-group">
                  <div class="row div_row_tarjeta">
                     <div class="col-12 div_tarjeta_arriba_encabezado_white" style="color: #E2001A;">
                        Datos de Solicitud
                     </div>
                     <div class="col-12 div_tarjeta_abajo_contenido">
                        <div class="row tamanio_letra_estandar" id="div_datos_de_solicitud">
                           <div class="col-12 form-group"></div>
                           <div class="col-12">                              
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Nombres:</div>
                                 <input type="text" id="nombres" class="col-9 form-control" placeholder="Nombres"/>    
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Apellido Paterno:</div>
                                 <input type="text" id="apellido_paterno" class="col-9 form-control" placeholder="Apellido Paterno"/>    
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Apellido Materno:</div>
                                 <input type="text" id="apellido_materno" class="col-9 form-control" placeholder="Apellido Materno"/>    
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Teléfono Local:</div>
                                 <input type="text" id="telefono_local" class="col-9 form-control" placeholder="Teléfono Local"/>    
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Teléfono Celular:</div>
                                 <input type="text" id="telefono_celular" class="col-9 form-control" placeholder="Teléfono Celular"/>    
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Email:</div>
                                 <input type="text" id="email" class="col-9 form-control" placeholder="Email"/>    
                              </div>                              
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Tipo de usuario:</div>
                                 <select id="id_tipo_de_usuario" class="col-9 form-control selectpicker" placeholder="Tipo de Usuario"></select>
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Fecha de Nacimiento:</div>
                                 <input type="date" id="fecha_de_nacimiento" class="col-9 form-control" placeholder="fecha_de_nacimiento"/>
                              </div> 
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Zona:</div>
                                 <select onchange="seleccionar_distribuidor()" id="id_ciudad" class="col-9 form-control selectpicker" placeholder="Zona"></select>
                              </div>
                              <div style="display: none;" id="div_distribuidor" class="row form-group">
                                       <div class="col-3 label_campo" style="text-align: right;">Distribuidor:</div>
                                       <select id="id_distribuidor" class="col-9 form-control selectpicker" placeholder="Distribuidor"></select>
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Contraseña:</div>
                                 <input type="password" id="secret" class="col-9 form-control" placeholder="Contraseña"/>
                              </div>
                              <div class="row form-group">
                                 <div class="col-3 label_campo" style="text-align: right;">Confirmación de Contraseña:</div>
                                 <input type="password" id="secret_2" class="col-9 form-control" placeholder="Contraseña"/>
                              </div>
                              <div class="row form-group">                                
                                <div id="errores" style="display: none;text-align: center;" class="col-12 tamanio_letra_errores">Errores</div>
                              </div>                              
                              <div class="row form-group">
                                       <div class="col-3"></div>
                                       <div class="col-2"></div>
                                       <div class="col-7 btn_rectangle" onclick="insertar()">Solicitar accesos</div>
                              </div>
                             </div>
                            </div>
                            <div class="col-12" id="div_completado" style="display: none;">
                              <div class="row form-group">                                
                                <div id="errores" style="text-align: center;" class="col-12 tamanio_letra_errores">Se han solicitado los accesos al administrador.
                                </div>
                              </div>                                 
                              <div class="row form-group">
                                       <div class="col-3"></div>
                                       <div class="col-2"></div>
                                       <div class="col-7 btn_rectangle" onclick="regresar();">Regresar</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </body>
          </head>
        </html>
                              